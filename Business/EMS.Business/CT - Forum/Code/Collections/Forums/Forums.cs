// Generated by Pnyx Generation tool at :06/04/2009 03:46:02 p.m.
using System;
using System.Collections.Generic;
using System.Text;
using System.Data;
using System.Data.Common;
using System.Data.SqlClient;
using Condesus.EMS.Business;
using Condesus.EMS.DataAccess;
using Condesus.EMS.Business.Security;

namespace Condesus.EMS.Business.CT.Collections
{
    internal class Forums
    {
        #region Internal properties
        private Credential _Credential;
        private ICollectionItems _Datasource;
        #endregion

        internal Forums(Credential credential) 
        {
            _Credential = credential;
            _Datasource = new ForumsRead.ForumsAll(credential);
        }

        internal Forums(PF.Entities.ProcessGroupProcess process) 
        {
            _Credential = process.Credential;
            _Datasource= new ForumsRead.ForumByProcess(process);
        }

        #region Read Functions
        /// <summary>
        /// Retorna ForumForums
        /// </summary>
        /// <returns></returns>
        internal Dictionary<Int64, Entities.Forum> Items()
        {
            Dictionary<Int64, Entities.Forum> _items = new Dictionary<Int64, Entities.Forum>();

            IEnumerable<System.Data.Common.DbDataRecord> _record = _Datasource.getItems();

            foreach (System.Data.Common.DbDataRecord _dbRecord in _record)
            {
                Entities.Forum _forum = new Factory.FactoryForum().CreateForum(Convert.ToInt64(_dbRecord["IdForum"]), Convert.ToBoolean(_dbRecord["IsActive"]),Convert.ToString(_dbRecord["idLanguage"]),Convert.ToString(_dbRecord["Name"]),Convert.ToString(_dbRecord["Description"]), _Credential);
                _items.Add(_forum.IdForum, _forum);
            }
            return _items;
        }


        /// <summary>
        /// Retorna ForumForums por ID
        /// </summary>
        /// <param name="IdMessage"></param>
        /// <returns></returns>
        internal Entities.Forum Item(Int64 IdForum)
        {
            DataAccess.CT.CollaborationTools _dbCollaborationTools = new Condesus.EMS.DataAccess.CT.CollaborationTools();

            Entities.Forum _forum = null;
            IEnumerable<System.Data.Common.DbDataRecord> _record = _dbCollaborationTools.ForumForums_ReadById(IdForum, _Credential.CurrentLanguage.IdLanguage);
            //Se modifica con los datos que realmente se tienen que usar...
            Dictionary<Object, System.Data.Common.DbDataRecord> _recordFilter = new Common.FilterLanguages(_record, "IdForum", _Credential).Filter();

            //si no trae nada retorno 0 para que no de error
            foreach (System.Data.Common.DbDataRecord _dbRecord in _recordFilter.Values)
            {
                return new Factory.FactoryForum().CreateForum(Convert.ToInt64(_dbRecord["IdForum"]), Convert.ToBoolean(_dbRecord["IsActive"]), Convert.ToString(_dbRecord["idLanguage"]), Convert.ToString(_dbRecord["Name"]), Convert.ToString(_dbRecord["Description"]), _Credential);
            }
            return _forum;    
        }

        //internal Entities.Forum Item(PF.Entities.ProcessGroupProcess process)
        //{
        //    DataAccess.PF.ProcessesFramework _dbProcessesFramework = new Condesus.EMS.DataAccess.PF.ProcessesFramework();

        //    IEnumerable<System.Data.Common.DbDataRecord> _record = _dbProcessesFramework.ProcessGroupProcessForums_ReadByProcess(process.IdProcess);
        //    foreach (System.Data.Common.DbDataRecord _dbRecord in _record)
        //    {
        //        if (Convert.ToBoolean(_dbRecord["IsDefault"]))
        //        {
        //            return this.Item(Convert.ToInt64(_dbRecord["IdForum"]));
        //        }
        //    }
        //    return null;
        //}
  
        #endregion


        #region Write Functions
        //Crea ForumForums
        internal Entities.Forum Create(String name, String description)
        {
            //Objeto de data layer para acceder a datos
            DataAccess.CT.CollaborationTools _dbCollaborationTools = new Condesus.EMS.DataAccess.CT.CollaborationTools();

            Boolean _isActive = true;
            //ejecuta el insert y devuelve el identificador que le asigno en la base de datos
            Int64 _idForum = _dbCollaborationTools.ForumForums_Create(_isActive);
            //alta del lg
            _dbCollaborationTools.ForumForums_LG_Create(_idForum, _Credential.DefaultLanguage.IdLanguage,name, description);
            //crea el objeto 
            Entities.Forum _Forum = new Factory.FactoryForum().CreateForum(_idForum, _isActive, _Credential.DefaultLanguage.IdLanguage, name, description, _Credential);
            
            DataAccess.Log.Log _dbLog = new Condesus.EMS.DataAccess.Log.Log();
            _dbLog.Create("CT_ForumForums", "Forums", "Add", "IdForum=" + _idForum, _Credential.User.IdPerson);

            return _Forum;

        }
        internal void Delete(Entities.Forum forum)
        {
            DataAccess.CT.CollaborationTools _dbCollaborationTools = new Condesus.EMS.DataAccess.CT.CollaborationTools();

            //Borra dependencias 
            forum.Remove();

            _dbCollaborationTools.ForumForums_Delete(forum.IdForum);

            
            DataAccess.Log.Log _dbLog = new Condesus.EMS.DataAccess.Log.Log();
            _dbLog.Create("CT_ForumForums", "Forums", "Delete", "IdForum=" + forum.IdForum, _Credential.User.IdPerson);

        }

        internal void Update(Entities.Forum forum, Boolean isActive)
        {
            DataAccess.CT.CollaborationTools _dbCollaborationTools = new Condesus.EMS.DataAccess.CT.CollaborationTools();

            _dbCollaborationTools.ForumForums_Update(forum.IdForum, isActive);

            DataAccess.Log.Log _dbLog = new Condesus.EMS.DataAccess.Log.Log();
            _dbLog.Create("CT_ForumForums", "Forums", "Update", "IdForum=" + forum.IdForum, _Credential.User.IdPerson);

        }
        internal void Update(Entities.Forum forum, String name, String description)
        {
            DataAccess.CT.CollaborationTools _dbCollaborationTools = new Condesus.EMS.DataAccess.CT.CollaborationTools();

            _dbCollaborationTools.ForumForums_LG_Update(forum.IdForum, forum.Credential.DefaultLanguage.IdLanguage, name,description);

            DataAccess.Log.Log _dbLog = new Condesus.EMS.DataAccess.Log.Log();
            _dbLog.Create("CT_ForumForums", "Forums", "Update", "IdForum=" + forum.IdForum, _Credential.User.IdPerson);

        }

        #endregion
    }
        
}

