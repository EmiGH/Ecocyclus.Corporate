// Generated by Pnyx Generation tool at :06/04/2009 03:46:02 p.m.
using System;
using System.Collections.Generic;
using System.Text;
using System.Data;
using System.Data.Common;
using System.Data.SqlClient;
using Condesus.EMS.Business;
using Condesus.EMS.DataAccess;
using Condesus.EMS.Business.Security;


namespace Condesus.EMS.Business.CT.Collections
{
    internal class Polls
    {
        private Credential _Credential;
        private ICollectionItems _Datasource;

        internal Polls(Entities.Message message) 
        {
            _Datasource = new PollsRead.PollsByMessages(message);
            _Credential = message.Credential;
        }

        internal Polls(Credential credential)
        {
            _Credential = credential;
            _Datasource = new PollsRead.PollsAll(credential);
        }

        #region Read Functions
        /// <summary>
        /// Retorna ForumPolls
        /// </summary>
        /// <returns></returns>
        internal Dictionary<Int64, Entities.Poll> Items()
        {
            Dictionary<Int64, Entities.Poll> _items = new Dictionary<Int64, Entities.Poll>();

            IEnumerable<System.Data.Common.DbDataRecord> _record = _Datasource.getItems();

            foreach (System.Data.Common.DbDataRecord _dbRecord in _record)
            {
                 CT.Entities.Poll _poll = new Entities.Poll(Convert.ToInt64(_dbRecord["IdPoll"]),Convert.ToInt64(_dbRecord["IdPerson"]),Convert.ToInt64(_dbRecord["IdMessage"]),Convert.ToDateTime(_dbRecord["PollDate"]),Convert.ToInt16(_dbRecord["Value"]));
                _items.Add(_poll.IdPoll, _poll);
            }
            return _items;
        }
        /// <summary>
        /// Retorna ForumPolls por ID
        /// </summary>
        /// <param name="IdMessage"></param>
        /// <returns></returns>
        internal Entities.Poll Item(Int64 idPoll)
        {
            DataAccess.CT.CollaborationTools _dbCollaborationTools = new Condesus.EMS.DataAccess.CT.CollaborationTools();

            Entities.Poll _poll = null;

            IEnumerable<System.Data.Common.DbDataRecord> _record = _dbCollaborationTools.ForumPolls_ReadById(idPoll);

            foreach (System.Data.Common.DbDataRecord _dbRecord in _record)
            {
                _poll = new Entities.Poll(Convert.ToInt64(_dbRecord["IdPoll"]), Convert.ToInt64(_dbRecord["IdPerson"]), Convert.ToInt64(_dbRecord["IdMessage"]), Convert.ToDateTime(_dbRecord["PollDate"]), Convert.ToInt16(_dbRecord["Value"]));
            }
            return _poll;

        }

        #endregion
        #region Write Functions
        //Crea ForumPolls
        internal Entities.Poll Create(Entities.Message message, Int16 Value)
        {

            DataAccess.CT.CollaborationTools _dbCollaborationTools = new Condesus.EMS.DataAccess.CT.CollaborationTools();

            Int64 _idPoll = _dbCollaborationTools.ForumPolls_Create(_Credential.User.IdPerson, message.IdMessage, DateTime.Now, Value);

            //Log
            DataAccess.Log.Log _dbLog = new Condesus.EMS.DataAccess.Log.Log();
            _dbLog.Create("CT_ForumPolls", "Polls", "Add", "IdPoll=" + _idPoll, _Credential.User.IdPerson);

            return new Entities.Poll(_idPoll, _Credential.User.IdPerson, message.IdMessage, DateTime.Now, Value);
        }
        internal void Delete(Entities.Poll poll)
        {
            DataAccess.CT.CollaborationTools _dbCollaborationTools = new Condesus.EMS.DataAccess.CT.CollaborationTools();

            _dbCollaborationTools.ForumPolls_Delete(poll.IdPoll);

            //Log
            DataAccess.Log.Log _dbLog = new Condesus.EMS.DataAccess.Log.Log();
            _dbLog.Create("CT_ForumPolls", "Polls", "Delete", "IdPoll=" + poll.IdPoll, _Credential.User.IdPerson);

        }

        internal void Update(Entities.Poll poll, byte value)
        {
            DataAccess.CT.CollaborationTools _dbCollaborationTools = new Condesus.EMS.DataAccess.CT.CollaborationTools();

            _dbCollaborationTools.ForumPolls_Update(poll.IdPoll,value);

            //Log
            DataAccess.Log.Log _dbLog = new Condesus.EMS.DataAccess.Log.Log();
            _dbLog.Create("CT_ForumPolls", "Polls", "Update", "IdPoll=" + poll.IdPoll, _Credential.User.IdPerson);

        }
    }
        #endregion
}

